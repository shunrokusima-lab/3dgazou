<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ç¾å ´Navi 3D - çµ±åˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
  <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

  <style>
    body { margin: 0; padding: 0; overflow: hidden; font-family: 'Hiragino Kaku Gothic ProN', sans-serif; }
    #cesiumContainer { width: 100%; height: 100vh; }
    
    #pano-container {
      display: none; position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%); width: 85%; height: 75%;
      background: #000; z-index: 1000; border: 4px solid #fff;
      box-shadow: 0 0 50px rgba(0,0,0,0.9);
    }
    #panorama, #regular-photo { width: 100%; height: 100%; }
    #regular-photo { display: none; object-fit: contain; background: #1a1a1a; }

    #close-btn {
      position: absolute; top: 12px; right: 12px; z-index: 1001;
      background: #e74c3c; color: white; border: none; padding: 12px 24px;
      cursor: pointer; font-weight: bold; border-radius: 4px; font-size: 16px;
    }

    #info-panel {
      position: absolute; top: 20px; left: 20px; background: rgba(25, 25, 25, 0.9);
      color: white; padding: 18px; border-radius: 10px; z-index: 500; font-size: 14px;
      line-height: 1.8; border-left: 6px solid #3498db;
    }

    #measure-panel {
      position: absolute; top: 20px; right: 20px; background: rgba(40, 40, 40, 0.9);
      color: white; padding: 15px; border-radius: 8px; z-index: 1000; width: 180px;
    }
    .measure-btn {
      width: 100%; padding: 8px; margin-top: 10px; cursor: pointer;
      background: #3498db; color: white; border: none; border-radius: 4px; font-weight: bold;
    }
    .measure-btn.active { background: #e67e22; }
    .clear-btn { background: #95a5a6; }

    .dimension-label {
        background-color: rgba(255, 235, 59, 0.95);
        color: #c0392b; border: 2px solid #c0392b;
        padding: 4px 10px; font-size: 15px; font-weight: bold; border-radius: 4px;
    }
  </style>
</head>

<body>
  <div id="info-panel">
    <b style="font-size: 16px;">ã€ç¾å ´Navi 3Dã€‘</b><br>
    <span style="color: #3498db;">â– </span> <b>é’æ ã‚¨ãƒªã‚¢</b>ï¼šè¨ˆç”»æ•·åœ°ï¼ˆåŠé€æ˜ï¼‰<br>
    ğŸ“ <b>èµ¤ãƒ”ãƒ³</b>ï¼š360Â°ãƒ‘ãƒãƒ©ãƒç”»åƒ<br>
    ğŸ“· <b>ã‚«ãƒ¡ãƒ©</b>ï¼šæ–½å·¥å†™çœŸ(å˜ä½“)<br>
    <hr style="border: 0; border-top: 1px solid #555; margin: 10px 0;">
    <small>â€»ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã§åº§æ¨™ã‚’å–å¾—(F12)</small>
  </div>

  <div id="measure-panel">
    <b>ğŸ“ è·é›¢è¨ˆæ¸¬ãƒ„ãƒ¼ãƒ«</b>
    <div id="measure-status" style="font-size: 12px; margin-top: 5px; color: #ccc;">åœæ­¢ä¸­</div>
    <button id="start-measure" class="measure-btn" onclick="toggleMeasure()">è¨ˆæ¸¬é–‹å§‹</button>
    <button class="measure-btn clear-btn" onclick="clearMeasure()">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
  
  <div id="cesiumContainer"></div>
  
  <div id="pano-container">
    <button id="close-btn" onclick="closePano()">Ã— é–‰ã˜ã‚‹</button>
    <div id="panorama"></div>
    <img id="regular-photo" src="">
  </div>

  <script>
    const CESIUM_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJhNGNjZDY5Ni00OTZmLTRkYjUtOWU0Yi02NTYzYmZmYTQzYWMiLCJpZCI6Mzc5MDEzLCJpYXQiOjE3Njg0NzM2MjR9.FKr4TDitEebTSNkEdy_VJ0NjYNkGfztPrcf1VDyBs30'; 
    const GOOGLE_API_KEY = 'AIzaSyAaEXs0u7x4V2k_elvzlEJTWPkJoCYuLGU';

    const ICONS = {
        '360': 'https://img.icons8.com/color/48/marker.png',
        'photo': 'https://img.icons8.com/fluency/48/camera.png',
        'memo': 'https://img.icons8.com/color/48/note.png',
        'default': 'https://img.icons8.com/color/48/marker.png'
    };

    Cesium.Ion.defaultAccessToken = CESIUM_TOKEN;
    const viewer = new Cesium.Viewer('cesiumContainer', {
      baseLayerPicker: false, timeline: false, animation: false,
      geocoder: false, homeButton: false, sceneModePicker: false
    });

    async function initMap() {
      try {
        const tileset = await Cesium.createGooglePhotorealistic3DTileset(GOOGLE_API_KEY);
        viewer.scene.primitives.add(tileset);
        
        // ä¿®æ­£ï¼šæ•·åœ°åº§æ¨™ã«åˆã‚ã›ã¦åˆæœŸè¡¨ç¤ºä½ç½®ã‚’ä¿®æ­£
        viewer.camera.flyTo({
          destination: Cesium.Cartesian3.fromDegrees(135.563168, 34.518490, 400),
          orientation: { pitch: Cesium.Math.toRadians(-35.0) }
        });
      } catch (e) { console.error(e); }
    }
    initMap();

    // è¨ˆæ¸¬ç”¨å¤‰æ•°
    let isMeasuring = false;
    let measurePoints = [];
    let measureEntities = [];

    function toggleMeasure() {
      isMeasuring = !isMeasuring;
      const btn = document.getElementById('start-measure');
      const status = document.getElementById('measure-status');
      if (isMeasuring) {
        btn.innerText = "è¨ˆæ¸¬ä¸­...";
        btn.classList.add('active');
        status.innerText = "1ç‚¹ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„";
        measurePoints = [];
      } else {
        btn.innerText = "è¨ˆæ¸¬é–‹å§‹";
        btn.classList.remove('active');
        status.innerText = "åœæ­¢ä¸­";
      }
    }

    function clearMeasure() {
      measureEntities.forEach(e => viewer.entities.remove(e));
      measureEntities = [];
      measurePoints = [];
      document.getElementById('measure-status').innerText = "åœæ­¢ä¸­";
    }

    // æ•·åœ°å¢ƒç•Œé–¢æ•°ï¼ˆãƒ©ãƒ™ãƒ«æ©Ÿèƒ½ã‚’è¿½åŠ ï¼‰
    function addSiteBoundary(coords, color, siteName) {
      let totalLon = 0; let totalLat = 0;
      for (let i = 0; i < coords.length; i += 2) {
        totalLon += coords[i]; totalLat += coords[i+1];
      }
      const centerLon = totalLon / (coords.length / 2);
      const centerLat = totalLat / (coords.length / 2);

      viewer.entities.add({
        name: siteName,
        polygon: {
          hierarchy: Cesium.Cartesian3.fromDegreesArray(coords),
          material: color.withAlpha(0.3),
          classificationType: Cesium.ClassificationType.BOTH
        },
        polyline: {
          positions: Cesium.Cartesian3.fromDegreesArray(coords.concat([coords[0], coords[1]])),
          width: 5, material: color, clampToGround: true,
          classificationType: Cesium.ClassificationType.BOTH
        },
        label: {
          text: siteName, font: 'bold 18px sans-serif', fillColor: Cesium.Color.YELLOW,
          outlineColor: Cesium.Color.BLACK, outlineWidth: 3,
          style: Cesium.LabelStyle.FILL_AND_OUTLINE, heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
          verticalOrigin: Cesium.VerticalOrigin.BOTTOM, pixelOffset: new Cesium.Cartesian2(0, -20),
          disableDepthTestDistance: Number.POSITIVE_INFINITY
        }
      });
    }

    function addPoint(lat, lon, height, name, type, imgFile, hotspots = []) {
      const iconImage = ICONS[type] || ICONS['default'];
      const entity = viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(lon, lat, height),
        billboard: {
          image: iconImage, verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
          heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
          width: 42, height: 42, disableDepthTestDistance: Number.POSITIVE_INFINITY
        },
        name: name
      });
      entity.customData = { type: type, url: `./${imgFile}`, hotspots: hotspots };
    }

    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    let panoViewer = null;

    handler.setInputAction(function(click) { 
      const pickedPosition = viewer.scene.pickPosition(click.position); 
      const pickedObject = viewer.scene.pick(click.position);

      // 1. è¨ˆæ¸¬ãƒ¢ãƒ¼ãƒ‰
      if (isMeasuring && Cesium.defined(pickedPosition)) {
        measurePoints.push(pickedPosition);
        const pointEntity = viewer.entities.add({
          position: pickedPosition,
          point: { pixelSize: 10, color: Cesium.Color.YELLOW, disableDepthTestDistance: Number.POSITIVE_INFINITY }
        });
        measureEntities.push(pointEntity);

        if (measurePoints.length === 1) {
          document.getElementById('measure-status').innerText = "2ç‚¹ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„";
        } else if (measurePoints.length === 2) {
          const distance = Cesium.Cartesian3.distance(measurePoints[0], measurePoints[1]);
          const lineEntity = viewer.entities.add({
            polyline: { positions: measurePoints, width: 4, material: Cesium.Color.YELLOW, disableDepthTestDistance: Number.POSITIVE_INFINITY }
          });
          const labelEntity = viewer.entities.add({
            position: Cesium.Cartesian3.lerp(measurePoints[0], measurePoints[1], 0.5, new Cesium.Cartesian3()),
            label: { 
              text: distance.toFixed(2) + " m", font: 'bold 16px sans-serif', 
              showBackground: true, backgroundColor: Cesium.Color.BLACK,
              disableDepthTestDistance: Number.POSITIVE_INFINITY 
            }
          });
          measureEntities.push(lineEntity, labelEntity);
          document.getElementById('measure-status').innerText = "è¨ˆæ¸¬å®Œäº†: " + distance.toFixed(2) + "m";
          toggleMeasure(); 
        }
        return; 
      }

      // 2. ãƒ”ãƒ³ã‚¯ãƒªãƒƒã‚¯
      if (Cesium.defined(pickedObject) && pickedObject.id && pickedObject.id.customData) {
        const data = pickedObject.id.customData;
        document.getElementById('pano-container').style.display = 'block';
        if (data.type === '360') {
          document.getElementById('panorama').style.display = 'block';
          document.getElementById('regular-photo').style.display = 'none';
          if (panoViewer) panoViewer.destroy();
          panoViewer = pannellum.viewer('panorama', {
            "type": "equirectangular", "panorama": data.url, "autoLoad": true,
            "hotSpots": data.hotspots, "crossOrigin": "anonymous"
          });
        } else if (data.type === 'photo') {
          document.getElementById('panorama').style.display = 'none';
          document.getElementById('regular-photo').style.display = 'block';
          document.getElementById('regular-photo').src = data.url;
        }
      } else {
        if (pickedPosition) {
          const carto = Cesium.Cartographic.fromCartesian(pickedPosition);
          console.log(`${Cesium.Math.toDegrees(carto.longitude).toFixed(6)}, ${Cesium.Math.toDegrees(carto.latitude).toFixed(6)}`);
        }
      } 
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    function closePano() {
      document.getElementById('pano-container').style.display = 'none';
      if (panoViewer) panoViewer.destroy();
      document.getElementById('regular-photo').src = "";
    }

    // ãƒ‡ãƒ¼ã‚¿ç™»éŒ²
    const siteArea = [
        135.562462, 34.519010, 
        135.562540, 34.518707, 
        135.562443, 34.518682, 
        135.562377, 34.518956 
    ];
    // ç¬¬3å¼•æ•°ã«åå‰ã‚’è¿½åŠ ã—ã¾ã—ãŸ
    addSiteBoundary(siteArea, Cesium.Color.SKYBLUE, "è¨ˆç”»åœ° Aå·¥åŒº");

    // ãƒ”ãƒ³ç™»éŒ²ï¼ˆä»¥ä¸‹ã¯ã”æç¤ºã®ãƒ‡ãƒ¼ã‚¿ï¼‰
    addPoint(34.519329, 135.562531, 98.0, "ãƒ†ã‚¹ãƒˆãƒ‘ãƒãƒ©ãƒåœ°ç‚¹", "360", "view01.JPG", []);
    addPoint(34.517793, 135.562679, 95.66, "ç”»åƒâ‘ ", "photo", "IMG_0433.PNG", []);
    addPoint(34.517329, 135.562961, 98.06, "ç”»åƒâ‘¡", "photo", "IMG_0434.PNG", []);
    addPoint(34.517610, 135.562945, 96.54, "ç”»åƒâ‘¢", "photo", "IMG_0435.PNG", []);
    addPoint(34.518484, 135.562452, 95.21, "ç”»åƒâ‘£", "photo", "IMG_0436.PNG", []);
    addPoint(34.518573, 135.562393, 95.05, "ç”»åƒâ‘¤", "photo", "IMG_0437.PNG", []);
    addPoint(34.519045, 135.562227, 94.62, "ç”»åƒâ‘¥", "photo", "IMG_0438.PNG", []);
    addPoint(34.520433, 135.562157, 94.36, "ç”»åƒâ‘¦", "photo", "IMG_0439.PNG", []);
    addPoint(34.520422, 135.561945, 94.31, "ç”»åƒâ‘§", "photo", "IMG_0440.PNG", []);
    addPoint(34.518007, 135.562379, 96.87, "360åº¦1", "360", "1.JPG", []);
    addPoint(34.518116, 135.561823, 98.94, "360åº¦2", "360", "2.JPG", []);
    addPoint(34.519276, 135.561624, 99.21, "360åº¦3", "360", "3.JPG", []);
    addPoint(34.519273, 135.561905, 99.63, "360åº¦4", "360", "4.JPG", []);
    addPoint(34.519294, 135.562324, 99.60, "360åº¦5", "360", "5.JPG", []);
    addPoint(34.519005, 135.562643, 98.15, "360åº¦6", "360", "6.JPG", []);
    addPoint(34.518703, 135.562626, 99.14, "360åº¦7", "360", "7.JPG", []);
    addPoint(34.518638, 135.562783, 99.06, "360åº¦8", "360", "8.JPG", []);
    addPoint(34.518721, 135.562922, 98.95, "360åº¦9", "360", "9.JPG", []);
    addPoint(34.518932, 135.562879, 98.75, "360åº¦10", "360", "10.JPG", []);
    addPoint(34.519686, 135.562554, 97.22, "360åº¦11", "360", "11.JPG", []);
    addPoint(34.520166, 135.562517, 97.39, "360åº¦12", "360", "12.JPG", []);
    addPoint(34.519261, 135.562070, 99.74, "360åº¦13", "360", "13.JPG", []);
    addPoint(34.518478, 135.562445, 95.21, "360åº¦14", "360", "14.JPG", []);
    addPoint(34.518729, 135.562317, 95.10, "360åº¦15", "360", "15.JPG", []);
    addPoint(34.520384, 135.561967, 94.33, "360åº¦16", "360", "16.JPG", []);
    addPoint(34.517855, 135.562653, 95.64, "360åº¦17", "360", "17.JPG", []);
    addPoint(34.519481, 135.561595, 95.46, "360åº¦18", "360", "18.JPG", []);
    addPoint(34.519039, 135.562231, 94.66, "360åº¦19", "360", "19.JPG", []);
    addPoint(34.517296, 135.562873, 97.87, "360åº¦21", "360", "21.JPG", []);
    addPoint(34.520435, 135.562154, 94.38, "360åº¦22", "360", "22.JPG", []);
    addPoint(34.517363, 135.563045, 97.94, "360åº¦23", "360", "23.JPG", []);
  </script>
</body>
</html>