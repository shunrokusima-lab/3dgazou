<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>3D現場管理システム - GitHub版</title>
  
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
  <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

  <style>
    body { margin: 0; padding: 0; overflow: hidden; }
    #cesiumContainer { width: 100%; height: 100vh; }
    
    /* パノラマ表示用ポップアップ */
    #pano-container {
      display: none; position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%); width: 85%; height: 75%;
      background: #000; z-index: 1000; border: 4px solid #fff;
    }
    #panorama { width: 100%; height: 100%; }
    #close-btn {
      position: absolute; top: 10px; right: 10px; z-index: 1001;
      background: red; color: white; border: none; padding: 10px; cursor: pointer;
    }
    #info-panel {
      position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7);
      color: white; padding: 10px; border-radius: 5px; z-index: 500;
    }
  </style>
</head>

<body>
  <div id="info-panel">
    マップをクリック：座標取得（F12で確認）<br>
    ピンをクリック：360度パノラマ表示
  </div>
  
  <div id="cesiumContainer"></div> <div id="pano-container"> <button id="close-btn" onclick="document.getElementById('pano-container').style.display='none'">閉じる</button>
    <div id="panorama"></div>
  </div>

  <script>
    // 【D】 各種設定：ここをご自身のキーに変えてください
    const CESIUM_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJhNGNjZDY5Ni00OTZmLTRkYjUtOWU0Yi02NTYzYmZmYTQzYWMiLCJpZCI6Mzc5MDEzLCJpYXQiOjE3Njg0NzM2MjR9.FKr4TDitEebTSNkEdy_VJ0NjYNkGfztPrcf1VDyBs30';
    const GOOGLE_API_KEY = 'AIzaSyAaEXs0u7x4V2k_elvzlEJTWPkJoCYuLGU';

    Cesium.Ion.defaultAccessToken = CESIUM_TOKEN;

    // マップの起動
    const viewer = new Cesium.Viewer('cesiumContainer', {
      baseLayerPicker: false, timeline: false, animation: false
    });

    // Google 3Dタイルの読み込み
    async function initMap() {
      try {
        const tileset = await Cesium.createGooglePhotorealistic3DTileset(GOOGLE_API_KEY);
        viewer.scene.primitives.add(tileset);
        
        // 初期の視点を東京に設定
        viewer.camera.flyTo({
          destination: Cesium.Cartesian3.fromDegrees(139.767, 35.681, 1000),
          orientation: { pitch: Cesium.Math.toRadians(-35.0) }
        });
      } catch (e) { console.error(e); }
    }
    initMap();

    // 【E】 360度写真のピンを立てる関数
    function add360Point(lat, lon, height, name, imgFile) {
      const entity = viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(lon, lat, height),
        billboard: {
          image: 'https://img.icons8.com/color/48/marker.png', // ピンのアイコン
          verticalOrigin: Cesium.VerticalOrigin.BOTTOM
        },
        name: name
      });
      // GitHubの同じフォルダにある画像を読み込む設定
      entity.customData = { url: `./${imgFile}` };
    }

    // 【F】 クリック操作の処理
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    handler.setInputAction(function(click) {
      const picked = viewer.scene.pick(click.position);
      
      // もしピンをクリックしたら
      if (Cesium.defined(picked) && picked.id && picked.id.customData) {
        document.getElementById('pano-container').style.display = 'block';
        pannellum.viewer('panorama', {
          "type": "equirectangular",
          "panorama": picked.id.customData.url,
          "autoLoad": true,
          "crossOrigin": "anonymous"
        });
      } 
      // 何もない場所をクリックしたら（座標取得）
      else {
        const cartesian = viewer.scene.pickPosition(click.position);
        if (cartesian) {
          const carto = Cesium.Cartographic.fromCartesian(cartesian);
          const lon = Cesium.Math.toDegrees(carto.longitude);
          const lat = Cesium.Math.toDegrees(carto.latitude);
          const height = carto.height;
          console.log(`緯度: ${lat.toFixed(6)}, 経度: ${lon.toFixed(6)}, 高さ: ${height.toFixed(2)}`);
          alert(`位置を取得しました。\n緯度:${lat.toFixed(6)}\n経度:${lon.toFixed(6)}\n高さ:${height.toFixed(2)}\n\nF12のコンソールにコピー用コードが出ています。`);
        }
      }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    // ==========================================
    // 【G】 登録エリア：ここに現場写真を追加
    // ==========================================
    // add360Point(緯度, 経度, 高さ, "名称", "GitHub上のファイル名");
    add360Point(34.519329, 135.562531, 97.2, "現場入口", "https://raw.githubusercontent.com/shunrokusima-lab/3dgazou/main/view01.JPG");

  </script>
</body>
</html>