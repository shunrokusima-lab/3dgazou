<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>3D現場管理システム - 修正版</title>
  
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
  <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>

  <style>
    body { margin: 0; padding: 0; overflow: hidden; }
    #cesiumContainer { width: 100%; height: 100vh; }
    
    /* パノラマ表示用ポップアップ */
    #pano-container {
      display: none; position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%); width: 85%; height: 75%;
      background: #000; z-index: 1000; border: 4px solid #fff;
    }
    #panorama { width: 100%; height: 100%; }
    #close-btn {
      position: absolute; top: 10px; right: 10px; z-index: 1001;
      background: red; color: white; border: none; padding: 10px; cursor: pointer;
    }
    #info-panel {
      position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7);
      color: white; padding: 10px; border-radius: 5px; z-index: 500;
    }

    /* 寸法表示用ラベルのスタイル */
    .dimension-label {
        background-color: rgba(255, 255, 0, 0.8);
        color: black;
        border: 1px solid red;
        padding: 2px 5px;
        font-size: 14px;
        font-weight: bold;
    }
  </style>
</head>

<body>
  <div id="info-panel">
    マップをクリック：座標取得（F12で確認）<br>
    ピンをクリック：360度パノラマ表示
  </div>
  
  <div id="cesiumContainer"></div>
  
  <div id="pano-container">
    <button id="close-btn" onclick="closePano()">閉じる</button>
    <div id="panorama"></div>
  </div>

  <script>
    // 【D】 設定
    const CESIUM_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJhNGNjZDY5Ni00OTZmLTRkYjUtOWU0Yi02NTYzYmZmYTQzYWMiLCJpZCI6Mzc5MDEzLCJpYXQiOjE3Njg0NzM2MjR9.FKr4TDitEebTSNkEdy_VJ0NjYNkGfztPrcf1VDyBs30';
    const GOOGLE_API_KEY = 'AIzaSyAaEXs0u7x4V2k_elvzlEJTWPkJoCYuLGU';

    // 【新機能1】アイコン定義
    const ICONS = {
        '360': 'https://img.icons8.com/fluency/48/panorama.png',  // カメラマーク
        'memo': 'https://img.icons8.com/color/48/note.png',       // ノートマーク
        'default': 'https://img.icons8.com/color/48/marker.png'   // 通常ピン
    };

    Cesium.Ion.defaultAccessToken = CESIUM_TOKEN;

    const viewer = new Cesium.Viewer('cesiumContainer', {
      baseLayerPicker: false, timeline: false, animation: false
    });

    async function initMap() {
      try {
        const tileset = await Cesium.createGooglePhotorealistic3DTileset(GOOGLE_API_KEY);
        viewer.scene.primitives.add(tileset);
        viewer.camera.flyTo({
          destination: Cesium.Cartesian3.fromDegrees(135.562531, 34.519329, 500),
          orientation: { pitch: Cesium.Math.toRadians(-35.0) }
        });
      } catch (e) { console.error(e); }
    }
    initMap();

    // 【E】 ピンを立てる関数 (引数を修正しました)
    function addPoint(lat, lon, height, name, type, imgFile, hotspots = []) {
      // typeに合わせてアイコンを選択
      const iconImage = ICONS[type] || ICONS['default'];

      const entity = viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(lon, lat, height),
        billboard: {
          image: iconImage,
          verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
          heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND
        },
        name: name
      });

      // データの紐付け
      entity.customData = { 
        is360: (type === '360'),
        url: `./${imgFile}`,
        hotspots: hotspots 
      };
    }

    // 【F】 クリック操作の処理
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    let panoViewer = null;

    handler.setInputAction(function(click) {
      const picked = viewer.scene.pick(click.position);
      
      if (Cesium.defined(picked) && picked.id && picked.id.customData) {
        const data = picked.id.customData;
        if(data.is360) {
          document.getElementById('pano-container').style.display = 'block';
          if (panoViewer) panoViewer.destroy(); // 既存のビューワーを破棄
          
          panoViewer = pannellum.viewer('panorama', {
            "type": "equirectangular",
            "panorama": data.url,
            "autoLoad": true,
            "crossOrigin": "anonymous",
            "hotSpots": data.hotspots,
            "hotSpotDebug": true // クリックした場所のpitch/yawをコンソールに表示
          });
        }
      } else {
        const cartesian = viewer.scene.pickPosition(click.position);
        if (cartesian) {
          const carto = Cesium.Cartographic.fromCartesian(cartesian);
          console.log(`緯度: ${Cesium.Math.toDegrees(carto.latitude).toFixed(6)}, 経度: ${Cesium.Math.toDegrees(carto.longitude).toFixed(6)}, 高さ: ${carto.height.toFixed(2)}`);
        }
      }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    function closePano() {
      document.getElementById('pano-container').style.display = 'none';
    }

    // ==========================================
    // 【G】 登録エリア
    // ==========================================
    
    // 例：360度画像 (寸法ホットスポット付き)
    addPoint(34.519329, 135.562531, 90.2, "テスト地点", "360", "view01.JPG", [
        { pitch: -10, yaw: 170, type: "info", text: "梁下: 2,800mm", cssClass: "dimension-label" }
    ]);

    // 例：メモ用ピン (画像なし)
    addPoint(34.518719, 135.562425, 97.47, "計画地", "memo", "");

    // 1地点目
    addPoint(34.517793, 135.562679, 95.66, "画像①", "360", "IMG_0433.PNG", []);

    // 2地点目
    addPoint(34.517329, 135.562961, 98.06, "画像②", "360", "IMG_0434.PNG", []);

    // 3地点目
    addPoint(34.517610, 135.562945, 96.54, "画像③", "360", "IMG_0435.PNG", []);

    // 4地点目
    addPoint(34.518484, 135.562452, 95.21, "画像④", "360", "IMG_0436.PNG", []);

    // 5地点目
    addPoint(34.518573, 135.562393, 95.05, "画像⑤", "360", "IMG_0437.PNG", []);

    // 6地点目
    addPoint(34.519045, 135.562227, 94.62, "画像⑥", "360", "IMG_0438.PNG", []);

    // 7地点目
    addPoint(34.520433, 135.562157, 94.36, "画像⑦", "360", "IMG_0439.PNG", []);

    // 8地点目
    addPoint(34.520422, 135.561945, 94.31, "画像⑧", "360", "IMG_0440.PNG", []);

　　// 9地点目
    addPoint(34.518007, 135.562379, 96.87, "360度1", "default", "1.JPG", []);

    // 10地点目
    addPoint(34.518116, 135.561823, 98.94, "360度2", "default", "2.JPG", []);

    // 11地点目
    addPoint(34.519276, 135.561624, 99.21, "360度3", "default", "3.JPG", []);

    // 12地点目
    addPoint(34.519273, 135.561905, 99.63, "360度4", "default", "4.JPG", []);

    // 13地点目
    addPoint(34.519294, 135.562324, 99.60, "360度5", "default", "5.JPG", []);

    // 14地点目
    addPoint(34.519005, 135.562643, 98.15, "360度6", "default", "6.JPG", []);

    // 15地点目
    addPoint(34.518703, 135.562626, 99.14, "360度7", "default", "7.JPG", []);

    // 16地点目
    addPoint(34.518638, 135.562783, 99.06, "360度8", "default", "8.JPG", []);

    // 17地点目
    addPoint(34.518721, 135.562922, 98.95, "360度9", "default", "9.JPG", []);

    // 18地点目
    addPoint(34.518932, 135.562879, 98.75, "360度10", "default", "10.JPG", []);

    // 19地点目
    addPoint(34.519686, 135.562554, 97.22, "360度11", "default", "11.JPG", []);

    // 20地点目
    addPoint(34.520166, 135.562517, 97.39, "360度12", "default", "12.JPG", []);

    // 21地点目
    addPoint(34.519261, 135.562070, 99.74, "360度13", "default", "13.JPG", []);

    // 22地点目
    addPoint(34.518478, 135.562445, 95.21, "360度14", "default", "14.JPG", []);
 
    // 23地点目
    addPoint(34.518729, 135.562317, 95.10, "360度15", "default", "15.JPG", []);

    // 24地点目
    addPoint(34.520384, 135.561967, 94.33, "360度16", "default", "16.JPG", []);
 
    // 25地点目
    addPoint(34.517855, 135.562653, 95.64, "360度17", "default", "17.JPG", []);

    // 26地点目
    addPoint(34.519481, 135.561595, 95.46, "360度18", "default", "18.JPG", []);

    // 25地点目
    addPoint(34.519039, 135.562231, 94.66, "360度19", "default", "19.JPG", []);

    // 26地点目
    addPoint(34.517296, 135.562873, 97.87, "360度21", "default", "21.JPG", []);

    // 27地点目
    addPoint(34.520435, 135.562154, 94.38, "360度22", "default", "22.JPG", []);

    // 28地点目
    addPoint(34.517363, 135.563045, 97.94, "360度23", "default", "23.JPG", []);



  </script>
</body>
</html>